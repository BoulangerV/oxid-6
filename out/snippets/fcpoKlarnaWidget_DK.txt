<script>
window.klarnaAsyncCallback = function () {
    Klarna.Payments.init({
        client_token: "%%TOKEN%%"
    });

    Klarna.Payments.load({
        container: '#%%PAYMENT_CONTAINER_ID%%',
        payment_method_category: '%%PAYMENT_CATEGORY%%'
    }, function (res) {
        console.debug(res);
        var klarnaData = $.parseJSON('%%KLARNA_DATA%%');
        var klarnaBasket = $.parseJSON('%%KLARNA_BASKET%%');
        Klarna.Payments.authorize({
            payment_method_category: '%%PAYMENT_CATEGORY%%',
        }, {
            purchase_country: klarnaData.purchase_country,
            purchase_currency: klarnaData.currency,
            billing_address: {
                given_name: klarnaData.billing.given_name,
                family_name: klarnaData.billing.family_name,
                email: klarnaData.billing.email,
                street_address: klarnaData.billing.street_address,
                postal_code: klarnaData.billing.postal_code,
                city: klarnaData.billing.city,
                region: klarnaData.billing.region,
                phone: klarnaData.billing.phone,
                country: klarnaData.billing.country
            },
            shipping_address: {
                given_name: klarnaData.shipping.given_name,
                family_name: klarnaData.shipping.family_name,
                email: klarnaData.shipping.email,
                street_address: klarnaData.shipping.street_address,
                postal_code: klarnaData.shipping.postal_code,
                city: klarnaData.shipping.city,
                region: klarnaData.shipping.region,
                phone: klarnaData.shipping.phone,
                country: klarnaData.shipping.country
            },
            order_amount: klarnaBasket.order_amount,
            order_tax_amount: klarnaBasket.order_tax_amount,
            orderlines: %%KLARNA_ORDERLINES%%,
            customer: {
                date_of_birth: klarnaData.customer.date_of_birth,
                gender: klarnaData.customer.gender
            }
        }, function (res) {
            $("#fcpo_klarna_auth_token").val(res.authorization_token);
            console.debug(res);
        });
    });
};
</script>
<script src="https://x.klarnacdn.net/kp/lib/v1/api.js" async></script>